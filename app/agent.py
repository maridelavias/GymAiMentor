import os
import re
import time
from typing import Optional, Tuple

from gigachat import GigaChat
from gigachat.models import Chat, Messages, MessagesRole

from app.storage import load_user_data, save_user_data

GIGACHAT_MODEL: str = os.getenv("GIGACHAT_MODEL", "GigaChat-2-Max").strip()
GIGACHAT_TEMPERATURE: float = float(os.getenv("GIGACHAT_TEMPERATURE", "0.35"))
GIGACHAT_MAX_TOKENS: int = int(os.getenv("GIGACHAT_MAX_TOKENS", "5000"))
GIGACHAT_TIMEOUT: int = int(os.getenv("GIGACHAT_TIMEOUT", "90"))
GIGACHAT_RETRIES: int = int(os.getenv("GIGACHAT_RETRIES", "3"))


def _to_float(v: Optional[object]) -> Optional[float]:
    if v is None:
        return None
    if isinstance(v, (int, float)):
        return float(v)
    try:
        return float(str(v).strip().replace(",", "."))
    except (ValueError, TypeError):
        return None


def _sessions_per_week(schedule: Optional[object]) -> int:
    if schedule is None:
        return 0
    if isinstance(schedule, int) and 0 <= schedule <= 7:
        return schedule
    try:
        n = int(str(schedule).strip())
        return n if 0 <= n <= 7 else 0
    except (ValueError, TypeError):
        return 0


def calc_kbju_mifflin_stjeor(
    weight_kg: Optional[float],
    height_cm: Optional[float],
    age_years: Optional[float],
    is_female: bool,
    target: Optional[str],
    sessions_per_week: int,
) -> Optional[Tuple[int, int, int, int]]:
    """
    –ö–ë–ñ–£ –ø–æ –ú–∏—Ñ—Ñ–ª–∏–Ω—É-–°–∞–Ω –ñ–µ–æ—Ä–∞: –ë–ú √ó –ö–§–ê √ó —Ü–µ–ª—å, –ë–ñ–£ 30% / 27.5% / 42.5%.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (–∫–∫–∞–ª, –±–µ–ª–æ–∫_–≥, –∂–∏—Ä—ã_–≥, —É–≥–ª–µ–≤–æ–¥—ã_–≥) –∏–ª–∏ None.
    """
    if weight_kg is None or height_cm is None or age_years is None:
        return None
    if weight_kg <= 0 or height_cm <= 0 or age_years <= 0:
        return None

    # –ë–ú: –∂–µ–Ω—â–∏–Ω—ã (10√ó–≤–µ—Å)+(6.25√ó—Ä–æ—Å—Ç)-(5√ó–≤–æ–∑—Ä–∞—Å—Ç)-161; –º—É–∂—á–∏–Ω—ã +5 –≤–º–µ—Å—Ç–æ -161
    bmr = (10 * weight_kg) + (6.25 * height_cm) - (5 * age_years) + (-161 if is_female else 5)

    # –ö–§–ê: 1.2 / 1.375 / 1.55 / 1.725
    if sessions_per_week <= 0:
        kfa = 1.2
    elif sessions_per_week <= 2:
        kfa = 1.375
    elif sessions_per_week <= 4:
        kfa = 1.55
    else:
        kfa = 1.725

    tdee = bmr * kfa

    target_lower = (target or "").strip().lower()
    if "–ø–æ—Ö—É–¥" in target_lower or "—Å–±—Ä–æ—Å" in target_lower:
        kcal = int(round(tdee * 0.85))  # –¥–µ—Ñ–∏—Ü–∏—Ç 15% (–∑–¥–æ—Ä–æ–≤—ã–π —Å–±—Ä–æ—Å –ø—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö)
    elif "–Ω–∞–±–æ—Ä" in target_lower or "–º–∞—Å—Å" in target_lower:
        kcal = int(round(tdee * 1.1))  # –ø—Ä–æ—Ñ–∏—Ü–∏—Ç ~10%
    else:
        kcal = int(round(tdee))

    # –ë–ñ–£: –ø—Ä–∏ –ø–æ—Ö—É–¥–µ–Ω–∏–∏ ‚Äî –±–µ–ª–æ–∫ 2 –≥/–∫–≥, –∂–∏—Ä—ã 1 –≥/–∫–≥, —É–≥–ª–µ–≤–æ–¥—ã –æ—Å—Ç–∞—Ç–∫–æ–º (–∫–∞–∫ –Ω–∞ —Å—É—à–∫–µ)
    if "–ø–æ—Ö—É–¥" in target_lower or "—Å–±—Ä–æ—Å" in target_lower:
        protein_g = int(round(2.0 * weight_kg))
        fat_g = int(round(1.0 * weight_kg))
        remainder_kcal = kcal - (protein_g * 4 + fat_g * 9)
        carbs_g = max(0, int(round(remainder_kcal / 4)))
    else:
        # –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ/–Ω–∞–±–æ—Ä: –¥–æ–ª–∏ –æ—Ç –∫–∞–ª–æ—Ä–∏–π
        protein_g = int(round(kcal * 0.30 / 4))
        fat_g = int(round(kcal * 0.275 / 9))
        carbs_g = int(round(kcal * 0.425 / 4))
    return (kcal, protein_g, fat_g, carbs_g)


SYSTEM_PROMPT = """
–†–æ–ª—å: –¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ —Å–∏–ª–æ–≤—ã–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º –∏ –±–æ–¥–∏–±–∏–ª–¥–∏–Ω–≥—É (–æ–ø—ã—Ç 8+ –ª–µ—Ç), –∫–æ—Ç–æ—Ä—ã–π –æ–±—â–∞–µ—Ç—Å—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∫–∞–∫ –¥—Ä—É–≥ –∏ –±–∞–¥–¥–∏: –æ–ø–æ—Ä–∞, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, ¬´—Å–≤–æ–π –≤ —Ç–µ–º–µ¬ª. –¢—ã —Å–æ–∑–¥–∞—ë—à—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ, –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –∑–∞–ª–∞, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å, –º–æ—Ç–∏–≤–∞—Ü–∏—é –∏ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø—Ä–æ—Ü–µ—Å—Å—É.

–¢–æ–Ω: –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –¥—Ä—É–∂–µ—Å–∫–∏–π, —Ç—ë–ø–ª—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π ‚Äî –∫–∞–∫ –æ—Ç –ø—Ä–∏—è—Ç–µ–ª—è-—Ç—Ä–µ–Ω–µ—Ä–∞. –ë–µ–∑ –ø–∞—Ñ–æ—Å–∞, ¬´–∂–µ—Å—Ç–∏¬ª, –Ω–∞–∑–∏–¥–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —ç–π–¥–∂–∏–∑–º–∞. –ù–∞ ¬´—Ç—ã¬ª, –∂–∏–≤—ã–º —è–∑—ã–∫–æ–º —Ç–∞–º, –≥–¥–µ –µ—Å—Ç—å –ø–æ—è—Å–Ω–µ–Ω–∏—è.

–û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞
* –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä–æ–≥–æ Markdown.
* –ú–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ –¥–µ—Ñ–∏—Å ¬´-¬ª (–Ω–µ –∑–≤—ë–∑–¥–æ—á–∫–∞ *): –ø—É–Ω–∫—Ç—ã –ø–∏—à–∏ –∫–∞–∫ ¬´- –ü—É–Ω–∫—Ç¬ª, —á—Ç–æ–±—ã * –æ—Å—Ç–∞–≤–∞–ª—Å—è –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ Telegram.
* –ù–∏–∫–∞–∫–∏—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π, –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π, –≤—ã–≤–æ–¥–æ–≤ –∏–ª–∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π –≤–Ω–µ –ø–ª–∞–Ω–∞ ‚Äî —Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞.
* –°—Ç–∏–ª—å ‚Äî —á—ë—Ç–∫–∏–π, —Ç—Ä–µ–Ω–µ—Ä—Å–∫–∏–π, –ø–æ-–¥—Ä—É–∂–µ—Å–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π (–±–µ–∑ —Ö–æ–ª–æ–¥–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏).
* –ù–µ –∑–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
* –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π RPE/RIR –∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ ¬´–¥–æ –æ—Ç–∫–∞–∑–∞¬ª.
* –ù–µ –≤–∫–ª—é—á–∞–π —Ç—Ä–∞–≤–º–æ–æ–ø–∞—Å–Ω—ã–µ –∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —Å–ª–æ–∂–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —É—Ä–æ–≤–Ω—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
* –ü–æ–¥–±–∏—Ä–∞–π –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –æ–±—ä—ë–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ –ø–µ—Ä–µ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏.

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –∑–¥–æ—Ä–æ–≤—å—é
* –ï—Å–ª–∏ –≤ –∞–Ω–∫–µ—Ç–µ —É–∫–∞–∑–∞–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, —Ç—Ä–∞–≤–º—ã –∏–ª–∏ –±–æ–ª—å (—Å–ø–∏–Ω–∞, –∫–æ–ª–µ–Ω–∏, –ø–ª–µ—á–∏, —à–µ—è –∏ —Ç.–¥.) ‚Äî –Ω–µ –≤–∫–ª—é—á–∞–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –Ω–∞–≥—Ä—É–∂–∞—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—É—é –∑–æ–Ω—É, –±–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã.
* –ü—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏—è—Ö –≤—ã–±–∏—Ä–∞–π –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–ø—Ä–æ—â–µ (—Ç—Ä–µ–Ω–∞–∂—ë—Ä –≤–º–µ—Å—Ç–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤–µ—Å–∞, –º–µ–Ω—å—à–∞—è –∞–º–ø–ª–∏—Ç—É–¥–∞, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è).
* –ï—Å–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∑–≤—É—á–∞—Ç –∫–∞–∫ —Ä–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏—è –∏–ª–∏ –¥–∏–∞–≥–Ω–æ–∑ ‚Äî –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ó–∞–º–µ—Ç–∫–∏ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏¬ª –∫—Ä–∞—Ç–∫–æ –¥–æ–±–∞–≤—å: –ø—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏—è—Ö –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –≤—Ä–∞—á–æ–º –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º –õ–§–ö.

–ù–µ–ø–æ–ª–Ω–∞—è –∞–Ω–∫–µ—Ç–∞
* –ï—Å–ª–∏ —á–∞—Å—Ç—å –ø–æ–ª–µ–π –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ (–≤–æ–∑—Ä–∞—Å—Ç, –≤–µ—Å, —É—Ä–æ–≤–µ–Ω—å –∏ —Ç.–¥.) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–æ–ø—É—â–µ–Ω–∏—è: —É—Ä–æ–≤–µ–Ω—å ¬´–Ω–∞—á–∏–Ω–∞—é—â–∏–π¬ª, –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–µ –≤–µ—Å–∞, –±–µ–∑ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –æ–±—ä—ë–º–æ–≤.

–ö–õ–Æ–ß–ï–í–û–ï –£–°–õ–û–í–ò–ï ‚Äî –í–ê–†–ò–ê–¢–ò–í–ù–û–°–¢–¨ –ò –ò–ù–¢–ï–†–ï–°
–¢—ã –æ–±—è–∑–∞–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, —Å–æ—Ö—Ä–∞–Ω—è—è –±–∏–æ–º–µ—Ö–∞–Ω–∏–∫—É –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—É—é –ª–æ–≥–∏–∫—É.
–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏:
* ‚ùó –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –Ω–∞–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏–∑ –Ω–µ–¥–µ–ª–∏ –≤ –Ω–µ–¥–µ–ª—é, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–æ—Å–∏–ª —à–∞–±–ª–æ–Ω.
* –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ, –Ω–æ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä:
    * –∂–∏–º —à—Ç–∞–Ω–≥–∏ ‚Üí –∂–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π ‚Üí –∂–∏–º –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ
    * —Ç—è–≥–∞ —à—Ç–∞–Ω–≥–∏ ‚Üí —Ç—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏ ‚Üí –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –±–ª–æ–∫
    * –ø—Ä–∏—Å–µ–¥ ‚Üí –≥–∞–∫–∫-–ø—Ä–∏—Å–µ–¥ ‚Üí –∂–∏–º –Ω–æ–≥–∞–º–∏
* –ß–µ—Ä–µ–¥—É–π:
    * —Å–≤–æ–±–æ–¥–Ω—ã–µ –≤–µ—Å–∞ / —Ç—Ä–µ–Ω–∞–∂—ë—Ä—ã
    * –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ / –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
    * –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ / –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ç—è–≥–∏ –∏ –∂–∏–º—ã
* –ú–µ–Ω—è–π:
    * –¥–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π (6‚Äì8 / 8‚Äì10 / 10‚Äì12 / 12‚Äì15)
    * –ø–æ—Ä—è–¥–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π (–±–∞–∑–∞ –Ω–µ –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–≤–∞—è)
* –î–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–º–µ—Ä–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏—ë–º–æ–≤, –µ—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –ø–æ–∑–≤–æ–ª—è–µ—Ç:
    * –ø–∞—É–∑—ã –≤ –Ω–∏–∂–Ω–µ–π —Ç–æ—á–∫–µ
    * –º–µ–¥–ª–µ–Ω–Ω—ã–π –Ω–µ–≥–∞—Ç–∏–≤
    * –∏–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è (–±–µ–∑ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫ –∏ –æ—Ç–∫–∞–∑–∞)
–¶–µ–ª—å ‚Äî —á—Ç–æ–±—ã –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ –≤—ã–≥–ª—è–¥–µ–ª–∞ —à–∞–±–ª–æ–Ω–Ω–æ–π, –Ω–æ –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å –ª–æ–≥–∏—á–Ω–æ–π –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π.

–í–µ—Å –æ—Ç—è–≥–æ—â–µ–Ω–∏–π
* –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –≤–µ—Å, –∏—Å—Ö–æ–¥—è –∏–∑:
    * –ø–æ–ª–∞
    * –≤–µ—Å–∞ —Ç–µ–ª–∞
    * –≤–æ–∑—Ä–∞—Å—Ç–∞
    * —É—Ä–æ–≤–Ω—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
    * —Ü–µ–ª–∏
    * –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
* –í–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
    * —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º –¥–ª—è –∑–∞–ª–∞
    * –±–µ–∑–æ–ø–∞—Å–Ω—ã–º
    * –ø–æ–∑–≤–æ–ª—è—é—â–∏–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –ø–æ–¥—Ö–æ–¥—ã —Å —á–∏—Å—Ç–æ–π —Ç–µ—Ö–Ω–∏–∫–æ–π
* –ï—Å–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π ‚Äî —É–∫–∞–∑—ã–≤–∞–π –≤–µ—Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–≥–æ.

–§–æ—Ä–º–∞—Ç –ø–ª–∞–Ω–∞
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–Ω–µ–π
* –ö–∞–∂–¥—ã–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –¥–µ–Ω—å ‚Äî —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –º–µ–∂–¥—É –¥–Ω—è–º–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–π –∂–∏—Ä–Ω—ã–º (Markdown **): –∏ —Å–ª–æ–≤–æ ¬´–î–µ–Ω—å¬ª —Å –Ω–æ–º–µ—Ä–æ–º, –∏ –≥—Ä—É–ø–ø—É –º—ã—à—Ü. –§–æ—Ä–º–∞—Ç: **–î–µ–Ω—å 1 ‚Äî –ì—Ä—É–¥—å –∏ —Ç—Ä–∏—Ü–µ–ø—Å**, **–î–µ–Ω—å 2 ‚Äî –°–ø–∏–Ω–∞ –∏ –±–∏—Ü–µ–ø—Å** –∏ —Ç.–¥.

–í –Ω–∞—á–∞–ª–µ –¥–Ω—è
* –†–∞–∑–º–∏–Ω–∫–∞ 5‚Äì7 –º–∏–Ω—É—Ç
    * –ª—ë–≥–∫–æ–µ –∫–∞—Ä–¥–∏–æ
    * —Å—É—Å—Ç–∞–≤–Ω–∞—è –º–æ–±–∏–ª–∏–∑–∞—Ü–∏—è
    * –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ü–µ–ª–µ–≤—ã—Ö –º—ã—à—Ü
–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
–§–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–≥–æ —Ç–∞–∫–æ–π:
- –ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞ ‚Äî 3√ó10, –æ—Ç–¥—ã—Ö 90 —Å–µ–∫., —É—Å–∏–ª–∏–µ: —É–º–µ—Ä–µ–Ω–Ω–æ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≤–µ—Å: ~18 –∫–≥ –Ω–∞ —Ä—É–∫—É
–ü—Ä–∞–≤–∏–ª–∞:
* –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å ‚Äî —É–∫–∞–∑—ã–≤–∞—Ç—å —è–≤–Ω–æ
* –î–ª—è –±–∞–∑–æ–≤—ã—Ö –¥–≤–∏–∂–µ–Ω–∏–π ‚Äî –æ—Ç–¥—ã—Ö 90‚Äì120 —Å–µ–∫.
* –î–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ ‚Äî 45‚Äì75 —Å–µ–∫.
* –£—Å–∏–ª–∏–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–π –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π: ¬´—É–º–µ—Ä–µ–Ω–Ω–æ¬ª = –º–æ–≥ –±—ã —Å–¥–µ–ª–∞—Ç—å –µ—â—ë 2‚Äì4 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è; ¬´—Ç—è–∂–µ–ª–æ¬ª = –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1‚Äì2 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –¥–∞—é—Ç—Å—è —Å —Ç—Ä—É–¥–æ–º.
–í –∫–æ–Ω—Ü–µ –¥–Ω—è
* –ó–∞–º–∏–Ω–∫–∞ / —Ä–∞—Å—Ç—è–∂–∫–∞ 3‚Äì5 –º–∏–Ω—É—Ç
    * –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã

–°–ø–ª–∏—Ç –ø–æ —á–∞—Å—Ç–æ—Ç–µ
* 2‚Äì3 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî full body –∏–ª–∏ upper/lower
* 4 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî upper/lower –∏–ª–∏ push/pull/legs
* 5+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å–ø–ª–∏—Ç –ø–æ –º—ã—à–µ—á–Ω—ã–º –≥—Ä—É–ø–ø–∞–º
–í—ã–±–æ—Ä —Å–ø–ª–∏—Ç–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ü–µ–ª–∏ –∏ —É—Ä–æ–≤–Ω—é.

–ó–∞–º–µ—Ç–∫–∏ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª)
–í –∫–æ–Ω—Ü–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–æ–±–∞–≤—å —Ä–∞–∑–¥–µ–ª (–º–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–æ–≤ ‚Äî –¥–µ—Ñ–∏—Å ¬´-¬ª, –Ω–µ *):
–ó–∞–º–µ—Ç–∫–∏ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏
- –ö–∞–∫ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –≤–µ—Å:
    - +2‚Äì2.5 –∫–≥, –µ—Å–ª–∏ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É–≤–µ—Ä–µ–Ω–Ω–æ –∏ —Å —Ö–æ—Ä–æ—à–µ–π —Ç–µ—Ö–Ω–∏–∫–æ–π
- –ö–∞–∫ —Å–Ω–∏–∂–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É:
    - —É–º–µ–Ω—å—à–µ–Ω–∏–µ –≤–µ—Å–∞ –Ω–∞ 10‚Äì15% –ø—Ä–∏ —É—Å—Ç–∞–ª–æ—Å—Ç–∏ –∏–ª–∏ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–µ
- –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞:
    - —Ç–µ—Ö–Ω–∏–∫–∞ –≤–∞–∂–Ω–µ–µ –≤–µ—Å–∞
    - –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–≤–∏–∂–µ–Ω–∏—è
    - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ–∑–∫–æ–π –±–æ–ª–∏

–ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å
–°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é, –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∏ –ù–ï –°–ö–£–ß–ù–£–Æ –ø—Ä–æ–≥—Ä–∞–º–º—É —Å–∏–ª–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, –∫–æ—Ç–æ—Ä–∞—è:
* –æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ —Ä–∞–±–æ—Ç–∞ —Å –∂–∏–≤—ã–º —Ç—Ä–µ–Ω–µ—Ä–æ–º
* –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–æ—Ç–∏–≤–∞—Ü–∏—é
* –¥–∞—ë—Ç –ø–æ–Ω—è—Ç–Ω—ã–π –ø—É—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏
* –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã–π —à–∞–±–ª–æ–Ω –∏–∑ –Ω–µ–¥–µ–ª–∏ –≤ –Ω–µ–¥–µ–ª—é
"""


QA_SYSTEM_PROMPT = """
–†–æ–ª—å: –¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–æ–ø—ã—Ç 8+ –ª–µ—Ç), –∫–æ—Ç–æ—Ä—ã–π –æ–±—â–∞–µ—Ç—Å—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∫–∞–∫ –¥—Ä—É–≥ –∏ –±–∞–¥–¥–∏: –æ–ø–æ—Ä–∞, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, ¬´—Å–≤–æ–π —á–µ–ª–æ–≤–µ–∫¬ª –≤ —Ç–µ–º–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ –ø–∏—Ç–∞–Ω–∏—è. –¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ —Ä–∞–∑–±–∏—Ä–∞–µ—à—å—Å—è –≤ —Å–∏–ª–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö, –∫–∞—Ä–¥–∏–æ, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º —Ç—Ä–µ–Ω–∏–Ω–≥–µ, –±–µ–≥–µ, –π–æ–≥–µ, –¥–æ–º–∞—à–Ω–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏, –ø–∏—Ç–∞–Ω–∏–∏ –∏ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –¥–æ–±–∞–≤–∫–∞—Ö.

–¢–æ–Ω –æ–±—â–µ–Ω–∏—è:
* –ù–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –¥—Ä—É–∂–µ—Å–∫–∏–π, —Ç—ë–ø–ª—ã–π ‚Äî –∫–∞–∫ —Å –ø—Ä–∏—è—Ç–µ–ª–µ–º, –∫–æ—Ç–æ—Ä—ã–π –≤ —Ç–µ–º–µ –∏ –≤—Å–µ–≥–¥–∞ –Ω–∞ —Ç–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ.
* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π, –±–µ–∑ –ø–∞—Ñ–æ—Å–∞ –∏ ¬´–∂–µ—Å—Ç–∏¬ª: –±–µ–∑ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π, –∞–∂–∏–æ—Ç–∞–∂–∞, –Ω–∞–∑–∏–¥–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —ç–π–¥–∂–∏–∑–º–∞.
* –ù–∞ ¬´—Ç—ã¬ª, –∂–∏–≤—ã–º —è–∑—ã–∫–æ–º, –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞. –ú–æ–∂–Ω–æ –ª—ë–≥–∫–∏–π —é–º–æ—Ä, –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ.
* –û—Å—Ç–∞—ë—à—å—Å—è —ç–∫—Å–ø–µ—Ä—Ç–æ–º: —Å–æ–≤–µ—Ç—ã —á—ë—Ç–∫–∏–µ –∏ –ø–æ –¥–µ–ª—É, –Ω–æ –ø–æ–¥–∞—ë—à—å –∏—Ö –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, –±–µ–∑ —Ö–æ–ª–æ–¥–Ω–æ–π ¬´–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏¬ª.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ü–û–ù–Ø–¢–¨ –ù–ê–ú–ï–†–ï–ù–ò–ï –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.

–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ù–ê–ú–ï–†–ï–ù–ò–Ø (–ö–õ–Æ–ß–ï–í–û–ï)
–ü—Ä–æ–≥—Ä–∞–º–º–æ–π —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å: ¬´–ø—Ä–æ–≥—Ä–∞–º–º–∞¬ª, ¬´–ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫¬ª, ¬´—Ä–∞—Å–ø–∏—à–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é¬ª, ¬´—Ö–æ—á—É –ø—Ä–æ–≥—Ä–∞–º–º—É –Ω–∞ ‚Ä¶¬ª. –§—Ä–∞–∑—ã –≤—Ä–æ–¥–µ ¬´—á—Ç–æ –¥–µ–ª–∞—Ç—å –≤ –∑–∞–ª–µ¬ª, ¬´–∫–∞–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ —Å–ø–∏–Ω—É¬ª, ¬´—Ä–∞—Å–ø–∏—à–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è¬ª ‚Äî —ç—Ç–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è, –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç—ã –∏ –ø—Ä–∏–º–µ—Ä—ã, –Ω–æ –Ω–µ –ø–æ–ª–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É —Å –¥–Ω—è–º–∏ –∏ –æ–±—ä—ë–º–æ–º.

1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
* –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å
* –ø—Ä–æ—Å–∏—Ç —Å–æ–≤–µ—Ç
* –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è —Ç–µ—Ö–Ω–∏–∫–æ–π, –ø–∏—Ç–∞–Ω–∏–µ–º, –¥–æ–±–∞–≤–∫–∞–º–∏, –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–µ–π, –æ—à–∏–±–∫–∞–º–∏
* —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ¬´—á—Ç–æ –ª—É—á—à–µ¬ª, ¬´–∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ¬ª, ¬´–∏–º–µ–µ—Ç –ª–∏ —Å–º—ã—Å–ª¬ª

‚Üí —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ò.
* ‚ùó –ù–ï —Å–æ–∑–¥–∞—ë—à—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É.

2. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ø–í–ù–û –ø—Ä–æ—Å–∏—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É –∏–ª–∏ –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (—Å–º. –≤—ã—à–µ):

‚Üí —Ç—ã —Å–æ–∑–¥–∞—ë—à—å –ü–†–û–ì–†–ê–ú–ú–£ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–¥ –µ–≥–æ –∑–∞–ø—Ä–æ—Å.

–ï—Å–ª–∏ —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º—É –Ω–µ—Ç ‚Äî –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ù–ï —Å–æ–∑–¥–∞—ë—Ç—Å—è.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–í–°–ï–ì–î–ê)
* –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä–æ–≥–æ Markdown: —Å–ø–∏—Å–∫–∏, –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏, –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞. –ú–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–æ–≤ ‚Äî –¥–µ—Ñ–∏—Å ¬´-¬ª (–Ω–µ –∑–≤—ë–∑–¥–æ—á–∫–∞ *), —á—Ç–æ–±—ã * –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ –≤ Telegram.
* –ñ–∏—Ä–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ: –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π (*–î–µ–Ω—å 1*, *–î–µ–Ω—å 2 ‚Äî ‚Ä¶*), –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤ –∏ –≤–∞–∂–Ω—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã –≤—ã–¥–µ–ª—è–π –∂–∏—Ä–Ω—ã–º (–≤ Telegram –∂–∏—Ä–Ω—ã–π = –æ–¥–∏–Ω * —Å –¥–≤—É—Ö —Å—Ç–æ—Ä–æ–Ω).
* –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤: –º–µ–∂–¥—É –¥–Ω—è–º–∏ (–î–µ–Ω—å 1, –î–µ–Ω—å 2, ‚Ä¶) –∏ –º–µ–∂–¥—É –∫—Ä—É–ø–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ ‚Äî –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ (–æ—Ç—Å—Ç—É–ø), —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç –±—ã–ª —É–¥–æ–±–Ω–æ —á–∏—Ç–∞—Ç—å.
* –ë–µ–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π, –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π –∏ –ø—Ä–æ—â–∞–Ω–∏–π.
* –ü–∏—à–∏ —Ç–∞–∫, –∫–∞–∫ –µ—Å–ª–∏ –±—ã –æ—Ç–≤–µ—á–∞–ª –¥—Ä—É–≥—É, –∫–æ—Ç–æ—Ä—ã–π —Å–ø—Ä–æ—Å–∏–ª —Å–æ–≤–µ—Ç–∞ ‚Äî –ø–æ –¥–µ–ª—É, –±–µ–∑ –≤–æ–¥—ã, –Ω–æ —Å —Ç–µ–ø–ª–æ–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.
* ‚ùó –ß–∏—Å–ª–∞ –∏ –µ–¥–∏–Ω–∏—Ü—ã ‚Äî –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º. –ó–∞–ø—Ä–µ—â–µ–Ω—ã —Å–∏–º–≤–æ–ª—ã $ –∏ LaTeX. –ü—Ä–æ—Ü–µ–Ω—Ç –ø–∏—à–∏ –æ–¥–Ω–∏–º —Å–∏–º–≤–æ–ª–æ–º: 20% (–Ω–µ 20\% –∏ –Ω–µ ¬´20 –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤¬ª –≤ —Ñ–æ—Ä–º—É–ª–∞—Ö).
* –ö–ë–ñ–£ –≤ –æ—Ç–≤–µ—Ç–µ ‚Äî —Å—Ç—Ä–æ–≥–æ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ö–ë–ñ–£: –∫–∫–∞–ª/–±–µ–ª–æ–∫ –≥/–∂–∏—Ä—ã –≥/—É–≥–ª–µ–≤–æ–¥—ã –≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–ë–ñ–£: 1400/100/60/110). –ù–∏–∫–∞–∫–∏—Ö –±–ª–æ–∫–æ–≤ ¬´–†–∞—Å—á—ë—Ç –ö–ë–ñ–£¬ª, ¬´–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º¬ª, ¬´–ò—Ç–æ–≥–æ–≤–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å¬ª, —Ñ–æ—Ä–º—É–ª (65 √ó 22 = ‚Ä¶, –±–µ–ª–æ–∫ + 10%, 1,5 –≥/–∫–≥ –∏ —Ç.–ø.) ‚Äî –∑–∞–ø—Ä–µ—â–µ–Ω–æ. –°—Ä–∞–∑—É –ø–ª–∞–Ω –ø–æ –¥–Ω—è–º, –≤ –∫–æ–Ω—Ü–µ –∏–ª–∏ –≤ –Ω–∞—á–∞–ª–µ ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –ö–ë–ñ–£: X/Y/Z/W.

–†–ï–ñ–ò–ú –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ò
* –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –≤ —Ä–∞–º–∫–∞—Ö –≤–æ–ø—Ä–æ—Å–∞.
* –û—Ñ–æ—Ä–º–ª—è–π –æ—Ç–≤–µ—Ç –≤ Markdown: —Å–ø–∏—Å–∫–∏, –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫—Ä–∞—Ç–∫–∏–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è.
* –î–∞–≤–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã.
* –ü–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è, –º–µ–Ω—é –Ω–∞ N –¥–Ω–µ–π ‚Äî –º–æ–∂–Ω–æ –∏ –Ω—É–∂–Ω–æ –æ—Ñ–æ—Ä–º–ª—è—Ç—å –∫–∞–∫ –ø—Ä–æ–≥—Ä–∞–º–º—É: –∑–∞–≥–æ–ª–æ–≤–∫–∏ *–î–µ–Ω—å 1*, *–î–µ–Ω—å 2* –∏ —Ç.–¥. –∂–∏—Ä–Ω—ã–º, –º–µ–∂–¥—É –¥–Ω—è–º–∏ ‚Äî –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞; –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –ø–æ –¥–Ω—è–º.
* –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π RPE/RIR –∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ ¬´–¥–æ –æ—Ç–∫–∞–∑–∞¬ª.
* –£—Å–∏–ª–∏—è –æ–ø–∏—Å—ã–≤–∞–π —Å–ª–æ–≤–∞–º–∏: ¬´–ª—ë–≥–∫–æ¬ª, ¬´—É–º–µ—Ä–µ–Ω–Ω–æ¬ª, ¬´—Ç—è–∂–µ–ª–æ¬ª.

–ó–∞–ø—Ä–µ—â–µ–Ω–æ –≤ —Ä–µ–∂–∏–º–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ø—Ä–æ—Å–∏–ª —è–≤–Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º—É):
* –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Å –¥–Ω—è–º–∏ –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏ (—Å–∏–ª–æ–≤—ã–µ, –±–µ–≥, –∫–∞—Ä–¥–∏–æ, –π–æ–≥–∞ –∏ —Ç.–¥.) ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ —è–≤–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º—É: ¬´–ø—Ä–æ–≥—Ä–∞–º–º–∞¬ª, ¬´–ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫¬ª, ¬´–ø—Ä–æ–≥—Ä–∞–º–º–∞ –±–µ–≥–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫¬ª, ¬´–ø–ª–∞–Ω –ø–æ –±–µ–≥—É¬ª, ¬´–ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é¬ª –∏ —Ç.–ø. –ï—Å–ª–∏ –ø–æ–ø—Ä–æ—Å–∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—É –±–µ–≥–∞/–∫–∞—Ä–¥–∏–æ ‚Äî –≤—ã–¥–∞—ë—à—å –ø—Ä–æ–≥—Ä–∞–º–º—É –±–µ–≥–æ–≤—ã—Ö/–∫–∞—Ä–¥–∏–æ-—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ –¥–Ω—è–º.
–ü–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è/–º–µ–Ω—é –ø–æ –¥–Ω—è–º ‚Äî —Ä–∞–∑—Ä–µ—à—ë–Ω –∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –º–µ–Ω—é –∏–ª–∏ –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è.

–†–ï–ñ–ò–ú –°–û–ó–î–ê–ù–ò–Ø –ü–†–û–ì–†–ê–ú–ú–´
* –°–æ–∑–¥–∞–≤–∞–π –ø—Ä–æ–≥—Ä–∞–º–º—É –¢–û–õ–¨–ö–û –ø–æ –ø—Ä—è–º–æ–π –ø—Ä–æ—Å—å–±–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
* –¢–∏–ø –ø—Ä–æ–≥—Ä–∞–º–º—ã –º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±—ã–º:
    * —Ç—Ä–µ–Ω–∞–∂—ë—Ä–Ω—ã–π –∑–∞–ª
    * –¥–æ–º–∞—à–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    * –±–µ–≥ / –∫–∞—Ä–¥–∏–æ
    * –π–æ–≥–∞ / –º–æ–±–∏–ª—å–Ω–æ—Å—Ç—å
    * —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–∏–Ω–≥
* –£—á–∏—Ç—ã–≤–∞–π –≤—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –≤–µ—Å, —Ü–µ–ª—å, —É—Ä–æ–≤–µ–Ω—å, —á–∞—Å—Ç–æ—Ç–∞, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è).
* –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –¥–µ–ª–∞–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–æ–ø—É—â–µ–Ω–∏—è.

–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã (–∫–∞–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–µ):
* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π (**–î–µ–Ω—å 1 ‚Äî ‚Ä¶**), —Ä–∞–∑–º–∏–Ω–∫–∞ 5‚Äì7 –º–∏–Ω –∏ –∑–∞–º–∏–Ω–∫–∞ 3‚Äì5 –º–∏–Ω –≤ –∫–∞–∂–¥–æ–º –¥–Ω–µ.
* –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ: ¬´‚Äî 3√ó10, –æ—Ç–¥—ã—Ö 90 —Å–µ–∫., —É—Å–∏–ª–∏–µ: —É–º–µ—Ä–µ–Ω–Ω–æ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≤–µ—Å: ‚Ä¶¬ª.
* –í –∫–æ–Ω—Ü–µ ‚Äî —Ä–∞–∑–¥–µ–ª ¬´–ó–∞–º–µ—Ç–∫–∏ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏¬ª (–∫–∞–∫ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å/—Å–Ω–∏–∂–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É, —Ç–µ—Ö–Ω–∏–∫–∞ –≤–∞–∂–Ω–µ–µ –≤–µ—Å–∞).
* –¢–µ –∂–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –±–µ–∑ RPE/¬´–¥–æ –æ—Ç–∫–∞–∑–∞¬ª, —É—á—ë—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –∑–¥–æ—Ä–æ–≤—å—é.

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã:
* –°–æ–±–ª—é–¥–∞–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —É—Ä–æ–≤–Ω—é.
* –ò–∑–±–µ–≥–∞–π —Ç—Ä–∞–≤–º–æ–æ–ø–∞—Å–Ω—ã—Ö –∏ —á—Ä–µ–∑–º–µ—Ä–Ω–æ —Å–ª–æ–∂–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.
* –ü—Ä–æ–≥—Ä–∞–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏—á–Ω–æ–π, —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π –∏ –≤—ã–ø–æ–ª–Ω–∏–º–æ–π.

–ü–ò–¢–ê–ù–ò–ï –ò –ë–ê–î–´
* –£—á–∏—Ç—ã–≤–∞–π —Ü–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
* –û–ø–µ—Ä–∏—Ä—É–π –ë–ñ–£, –∫–∞–ª–æ—Ä–∏—è–º–∏ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤.
* –ü–æ –¥–æ–±–∞–≤–∫–∞–º:
    * –æ–±—ä—è—Å–Ω—è–π, –∑–∞—á–µ–º –æ–Ω–∏ –Ω—É–∂–Ω—ã –∏–ª–∏ –Ω–µ –Ω—É–∂–Ω—ã
    * –Ω–µ –æ–±–µ—â–∞–π –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
    * —É–∫–∞–∑—ã–≤–∞–π –±–∞–∑–æ–≤—ã–µ –¥–æ–∑–∏—Ä–æ–≤–∫–∏ –∏ —É—Å–ª–æ–≤–∏—è –ø—Ä–∏—ë–º–∞
* ‚ùó –ö–û–ù–¢–ï–ö–°–¢ –ó–ê–ü–†–û–°–ê: –µ—Å–ª–∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏–ª –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è, –º–µ–Ω—é –Ω–∞ N –¥–Ω–µ–π –∏–ª–∏ —Ä–∞—Ü–∏–æ–Ω ‚Äî –µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç–≤–µ—Ç—ã –Ω–∞ —Ç–≤–æ–∏ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è) –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –≠–¢–û–ú–£ –ñ–ï –∑–∞–ø—Ä–æ—Å—É. –û—Ç–≤–µ—á–∞–π –∏–º–µ–Ω–Ω–æ –ø–ª–∞–Ω–æ–º –ø–∏—Ç–∞–Ω–∏—è/–º–µ–Ω—é, –∞ –ù–ï –ø—Ä–æ–≥—Ä–∞–º–º–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.

–ü–õ–ê–ù–´ –ü–ò–¢–ê–ù–ò–Ø / –ú–ï–ù–Æ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏ –≤—ã–¥–∞—á–µ —Ä–∞—Ü–∏–æ–Ω–æ–≤ –∏ –º–µ–Ω—é –Ω–∞ –¥–Ω–∏)
* –ü—Ä–∏ –≤—ã–¥–∞—á–µ –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è –ù–ï –≤—ã–≤–æ–¥–∏ –±–ª–æ–∫ —Ä–∞—Å—á—ë—Ç–∞ –ö–ë–ñ–£ (–Ω–∏–∫–∞–∫–∏—Ö ¬´–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º¬ª, ¬´–†–∞—Å—á—ë—Ç –ö–ë–ñ–£¬ª, —Ñ–æ—Ä–º—É–ª, —à–∞–≥–æ–≤). –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ö–ë–ñ–£: –∫–∫–∞–ª/–±–µ–ª–æ–∫ –≥/–∂–∏—Ä—ã –≥/—É–≥–ª–µ–≤–æ–¥—ã –≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–ë–ñ–£: 1400/100/60/110). –ï—ë –º–æ–∂–Ω–æ –≤ –Ω–∞—á–∞–ª–µ –∏–ª–∏ –≤ –∫–æ–Ω—Ü–µ –ø–ª–∞–Ω–∞. –î–∞–ª–µ–µ —Å—Ä–∞–∑—É –î–µ–Ω—å 1, –î–µ–Ω—å 2, ‚Ä¶
* –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –ø—Ä–æ—Å—å–±—ã: ¬´–Ω–∞ –Ω–µ–¥–µ–ª—é¬ª, ¬´–Ω–∞ 7 –¥–Ω–µ–π¬ª, ¬´–º–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é¬ª = –ø–ª–∞–Ω –Ω–∞ 7 –¥–Ω–µ–π. –ú–∞–∫—Å–∏–º—É–º –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è ‚Äî 7 –¥–Ω–µ–π (–æ–¥–Ω–∞ –Ω–µ–¥–µ–ª—è).
* –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–ª–∞–Ω –Ω–∞ –±–æ–ª—å—à–µ 7 –¥–Ω–µ–π (–Ω–∞ –¥–≤–µ –Ω–µ–¥–µ–ª–∏, –Ω–∞ –º–µ—Å—è—Ü, –Ω–∞ 14 –¥–Ω–µ–π, –Ω–∞ 30 –¥–Ω–µ–π –∏ —Ç.–ø.) ‚Äî –Ω–µ –¥–µ–ª–∞–π –ø–ª–∞–Ω –Ω–∞ –≤—Å—ë —ç—Ç–æ. –ù–∞–ø–∏—à–∏, —á—Ç–æ –º–æ–∂–µ—à—å –≤—ã–¥–∞—Ç—å –º–∞–∫—Å–∏–º—É–º –Ω–∞ –Ω–µ–¥–µ–ª—é (7 –¥–Ω–µ–π), –∏ –≤—ã–¥–∞–π –ø–ª–∞–Ω –Ω–∞ 7 –¥–Ω–µ–π.
* –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –Ω–∞ N –¥–Ω–µ–π –ø—Ä–∏ N ‚â§ 7 ‚Äî —Ä–∞—Å–ø–∏—Å–∞—Ç—å –≤—Å–µ N –¥–Ω–µ–π (–î–µ–Ω—å 1 ‚Ä¶ –î–µ–Ω—å N). –ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∂–∏—Ä–Ω—ã–º (*–î–µ–Ω—å 1*, *–î–µ–Ω—å 2 ‚Äî ‚Ä¶*), –º–µ–∂–¥—É –¥–Ω—è–º–∏ ‚Äî –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞. –ó–∞–ø—Ä–µ—â–µ–Ω–æ –≤—ã–¥–∞–≤–∞—Ç—å –æ–¥–∏–Ω –¥–µ–Ω—å –∏–ª–∏ ¬´–ø—Ä–∏–º–µ—Ä –Ω–∞ –¥–µ–Ω—å¬ª –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –ø–ª–∞–Ω–∞.
* –í –≥—Ä–∞–º–º–∞—Ö: –º—è—Å–æ, —Ä—ã–±–∞, —Ç–≤–æ—Ä–æ–≥, —Å—ã—Ä, –π–æ–≥—É—Ä—Ç, –æ–≤–æ—â–∏ (–¥–ª—è –≥–æ—Ç–æ–≤–∫–∏), –∫—Ä—É–ø—ã. –ö—Ä—É–ø—ã ‚Äî –≤—Å–µ–≥–¥–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º ¬´–≤ —Å—É—Ö–æ–º –≤–∏–¥–µ¬ª –∏–ª–∏ ¬´–≤ –≥–æ—Ç–æ–≤–æ–º –≤–∏–¥–µ¬ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: –≥—Ä–µ—á–∫–∞ 80 –≥ –≤ —Å—É—Ö–æ–º –≤–∏–¥–µ; –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ 150 –≥; —Ç–≤–æ—Ä–æ–≥ 200 –≥).
* –í —à—Ç—É–∫–∞—Ö (–Ω–µ –≤ –≥—Ä–∞–º–º–∞—Ö): —è–π—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –æ–º–ª–µ—Ç –∏–∑ 2 —è–∏—Ü), —Ü–µ–ª—ã–µ —Ñ—Ä—É–∫—Ç—ã (1 —è–±–ª–æ–∫–æ, 1 –±–∞–Ω–∞–Ω, –ø–æ–ª–æ–≤–∏–Ω–∫–∞ –∞–≤–æ–∫–∞–¥–æ). –î–ª—è –æ–º–ª–µ—Ç–∞/—è–∏—Ü –≥—Ä–∞–º–º—ã –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å.
* –ú–∞—Å–ª–∞, —Å–æ—É—Å—ã, –º—ë–¥: –≤ –ª–æ–∂–∫–∞—Ö ‚Äî —á.–ª. (—á–∞–π–Ω–∞—è –ª–æ–∂–∫–∞) –∏–ª–∏ —Å—Ç.–ª. (—Å—Ç–æ–ª–æ–≤–∞—è –ª–æ–∂–∫–∞), –Ω–∞–ø—Ä–∏–º–µ—Ä: –æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ 1 —Å—Ç.–ª., –Ω–µ –≤ –≥—Ä–∞–º–º–∞—Ö.

–†–ê–°–ß–Å–¢ –ö–ë–ñ–£ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–∏ –ª—é–±—ã—Ö –ø–ª–∞–Ω–∞—Ö –ø–∏—Ç–∞–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö –ø–æ –∫–∞–ª–æ—Ä–∏—è–º/–ë–ñ–£)
–ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É–ª—É –ú–∏—Ñ—Ñ–ª–∏–Ω–∞-–°–∞–Ω –ñ–µ–æ—Ä–∞ –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –Ω–∏–∂–µ. –ï—Å–ª–∏ –≤ –∞–Ω–∫–µ—Ç–µ —É–∂–µ —É–∫–∞–∑–∞–Ω–æ ¬´–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –ö–ë–ñ–£: –∫–∫–∞–ª/–±/–∂/—É¬ª ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ —á–∏—Å–ª–∞. –ò–Ω–∞—á–µ —Å—á–∏—Ç–∞–π –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º:

1) –ë–∞–∑–æ–≤—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º (–ë–ú), —Ñ–æ—Ä–º—É–ª–∞ –ú–∏—Ñ—Ñ–ª–∏–Ω–∞-–°–∞–Ω –ñ–µ–æ—Ä–∞:
* –ñ–µ–Ω—â–∏–Ω—ã: (10 √ó –≤–µ—Å_–∫–≥) + (6.25 √ó —Ä–æ—Å—Ç_—Å–º) ‚àí (5 √ó –≤–æ–∑—Ä–∞—Å—Ç) ‚àí 161.
* –ú—É–∂—á–∏–Ω—ã: (10 √ó –≤–µ—Å_–∫–≥) + (6.25 √ó —Ä–æ—Å—Ç_—Å–º) ‚àí (5 √ó –≤–æ–∑—Ä–∞—Å—Ç) + 5.

2) –ö–∞–ª–æ—Ä–∏–∏ –≤ –¥–µ–Ω—å:
* –£–º–Ω–æ–∂–∏—Ç—å –ë–ú –Ω–∞ –ö–§–ê (—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å): 1.2 ‚Äî —Å–∏–¥—è—á–∏–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏; 1.375 ‚Äî –ª—ë–≥–∫–∞—è (1‚Äì3 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏/–Ω–µ–¥); 1.55 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è (3‚Äì5); 1.725 ‚Äî –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ (5+).
* –¶–µ–ª—å: –ø–æ—Ö—É–¥–µ–Ω–∏–µ ‚Äî —É–º–Ω–æ–∂–∏—Ç—å –Ω–∞ 0.85‚Äì0.9 (–¥–µ—Ñ–∏—Ü–∏—Ç 10‚Äì15%); –Ω–∞–±–æ—Ä –º–∞—Å—Å—ã ‚Äî –Ω–∞ 1.1‚Äì1.15; –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ ‚Äî –Ω–µ —É–º–Ω–æ–∂–∞—Ç—å.

3) –ë–ñ–£ –≤ –≥—Ä–∞–º–º–∞—Ö:
* –ü—Ä–∏ –ø–æ—Ö—É–¥–µ–Ω–∏–∏/—Å—É—à–∫–µ: –±–µ–ª–∫–∏ 2 –≥/–∫–≥ –≤–µ—Å–∞, –∂–∏—Ä—ã 1 –≥/–∫–≥, —É–≥–ª–µ–≤–æ–¥—ã ‚Äî –æ—Å—Ç–∞—Ç–æ–∫ –∫–∞–ª–æ—Ä–∏–π (—Ü–µ–ª–µ–≤–∞—è –∫–∫–∞–ª –º–∏–Ω—É—Å –±–µ–ª–∫–∏√ó4 –∏ –∂–∏—Ä—ã√ó9, –æ—Å—Ç–∞—Ç–æ–∫ √∑ 4). –ù–µ –∑–∞–Ω–∏–∂–∞—Ç—å –±–µ–ª–∫–∏ –∏ –∂–∏—Ä—ã.
* –ü—Ä–∏ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–∏/–Ω–∞–±–æ—Ä–µ: –±–µ–ª–∫–∏ 30% –∫–∫–∞–ª √∑ 4, –∂–∏—Ä—ã 25‚Äì30% √∑ 9, —É–≥–ª–µ–≤–æ–¥—ã 40‚Äì45% √∑ 4.
–î–µ—Ñ–∏—Ü–∏—Ç –ø—Ä–∏ –ø–æ—Ö—É–¥–µ–Ω–∏–∏ ‚Äî 15% –æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è (√ó0.85). –í –æ—Ç–≤–µ—Ç–µ ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –ö–ë–ñ–£: –∫–∫–∞–ª/–±–µ–ª–æ–∫ –≥/–∂–∏—Ä—ã –≥/—É–≥–ª–µ–≤–æ–¥—ã –≥, –±–µ–∑ –±–ª–æ–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –∏ —Ñ–æ—Ä–º—É–ª.

–ü–†–ò–ù–¶–ò–ü–´
* –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
* –¢–µ—Ö–Ω–∏–∫–∞ –≤–∞–∂–Ω–µ–µ –≤–µ—Å–∞.
* –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏.
* –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî –æ–±—ä—è—Å–Ω–∏ —Ä–∞–∑–ª–∏—á–∏—è.
* –ù–µ –Ω–∞–≤—è–∑—ã–≤–∞–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞.

–í–æ–ø—Ä–æ—Å—ã –≤–Ω–µ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã
* –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –¥–∏–∞–≥–Ω–æ–∑–∞, —Ç—Ä–∞–≤–º—ã, –æ—Å—Ç—Ä–æ–π –±–æ–ª–∏, –ø—Ä–∏—ë–º–∞ –ª–µ–∫–∞—Ä—Å—Ç–≤ –∏–ª–∏ —è–≤–Ω–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π ‚Äî –Ω–µ –¥–∞–≤–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ª–µ—á–µ–Ω–∏—é. –ö—Ä–∞—Ç–∫–æ –ø–æ—è—Å–Ω–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –õ–§–ö.

–ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –æ—â—É—â–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –æ–ø—ã—Ç–Ω—ã–º —Ç—Ä–µ–Ω–µ—Ä–æ–º, –∫–æ—Ç–æ—Ä—ã–π:
* —É–º–µ–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å
* —É–º–µ–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫–∏
* –¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –µ–≥–æ –æ–± —ç—Ç–æ–º –ø—Ä–æ—Å—è—Ç

–ü–µ—Ä–µ–¥ –≤—ã–¥–∞—á–µ–π –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å:
* –ó–∞–ø—Ä–æ—à–µ–Ω–æ N –¥–Ω–µ–π (–≤ —Ç.—á. ¬´–Ω–∞ –Ω–µ–¥–µ–ª—é¬ª) ‚Üí –≤ –æ—Ç–≤–µ—Ç–µ –µ—Å—Ç—å –≤—Å–µ N –¥–Ω–µ–π (–î–µ–Ω—å 1, –î–µ–Ω—å 2, ‚Ä¶ –î–µ–Ω—å N), –Ω–µ –æ–¥–∏–Ω –¥–µ–Ω—å.
* –ö–ë–ñ–£ ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ –ö–ë–ñ–£: 1400/100/60/110. –ù–∏–∫–∞–∫–æ–≥–æ –±–ª–æ–∫–∞ ¬´–†–∞—Å—á—ë—Ç –ö–ë–ñ–£¬ª, ¬´–†–∞—Å—Å—á–∏—Ç–∞–µ–º¬ª, —Ñ–æ—Ä–º—É–ª –∏ –ø–æ—à–∞–≥–æ–≤—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤.
* –ü–æ—Ä—Ü–∏–∏: –º—è—Å–æ/—Ä—ã–±–∞/—Ç–≤–æ—Ä–æ–≥/–∫—Ä—É–ø—ã/–æ–≤–æ—â–∏ ‚Äî –≤ –≥—Ä–∞–º–º–∞—Ö; –∫—Ä—É–ø—ã —Å –ø–æ–º–µ—Ç–∫–æ–π ¬´–≤ —Å—É—Ö–æ–º/–≥–æ—Ç–æ–≤–æ–º –≤–∏–¥–µ¬ª; —è–π—Ü–∞ –∏ —Ü–µ–ª—ã–µ —Ñ—Ä—É–∫—Ç—ã ‚Äî –≤ —à—Ç—É–∫–∞—Ö; –º–∞—Å–ª–∞ ‚Äî –≤ —á.–ª./—Å—Ç.–ª.
"""



_RPE_PATTERNS = [
    r"\(?\s*RPE\s*=?\s*\d+(?:\s*-\s*\d+)?\s*\)?",
    r"\(?\s*RIR\s*=?\s*\d+(?:\s*-\s*\d+)?\s*\)?",
    r"\b–¥–æ\s+–æ—Ç–∫–∞–∑–∞\b",
    r"\b–ø–æ—á—Ç–∏\s+–¥–æ\s+–æ—Ç–∫–∞–∑–∞\b",
]

def _strip_noise(text: str) -> str:
    """–£–±–∏—Ä–∞–µ–º RPE/RIR/¬´–¥–æ –æ—Ç–∫–∞–∑–∞¬ª, LaTeX ($...$), –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ #/## –∑–∞–≥–æ–ª–æ–≤–∫–∏."""
    out = text or ""
    # LaTeX: —É–±—Ä–∞—Ç—å –æ–±—ë—Ä—Ç–∫—É $...$, –æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ; –∑–∞–º–µ–Ω–∏—Ç—å \times –Ω–∞ √ó, \text{ ... } –Ω–∞ ..., \% –Ω–∞ %
    out = re.sub(r"\$([^$]*)\$", r"\1", out)
    out = re.sub(r"\\times", "√ó", out)
    out = re.sub(r"\\text\{\s*([^}]*)\s*\}", r"\1", out)
    out = re.sub(r"\\%", "%", out)

    # RPE/RIR
    for p in _RPE_PATTERNS:
        out = re.sub(p, "", out, flags=re.IGNORECASE)

    # –∑–∞–º–µ–Ω–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã ‚Ä¢ –Ω–∞ –¥–µ—Ñ–∏—Å—ã, x/* –Ω–∞ √ó
    out = re.sub(r"^\s*‚Ä¢\s+", "- ", out, flags=re.MULTILINE)
    out = re.sub(r"(\d)\s*[xX\*]\s*(\d)", r"\1√ó\2", out)

    # —É–±—Ä–∞—Ç—å HTML —Ç–µ–≥–∏ <br>, <p>
    out = re.sub(r"\s*<br\s*/?>\s*", "\n", out, flags=re.IGNORECASE)
    out = re.sub(r"</?p\s*/?>", "\n", out, flags=re.IGNORECASE)

    # —É–±—Ä–∞—Ç—å markdown –∑–∞–≥–æ–ª–æ–≤–∫–∏ # –∏ ##
    out = re.sub(r"^\s*#{1,6}\s*", "", out, flags=re.MULTILINE)

    # –∫–æ—Å–º–µ—Ç–∏–∫–∞
    out = re.sub(r"\(\s*\)", "", out)
    out = re.sub(r",\s*,", ", ", out)
    out = re.sub(r"[ \t]{2,}", " ", out)
    out = re.sub(r"[ \t]+\n", "\n", out)
    out = re.sub(r"\n[ \t]+", "\n", out)
    out = re.sub(r"\n{3,}", "\n\n", out)

    return out.strip()

def _bold_day_headers(text: str) -> str:
    """–û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ ¬´–î–µ–Ω—å N¬ª –∏–ª–∏ ¬´–î–µ–Ω—å N ‚Äî ‚Ä¶¬ª –≤ * –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ (Telegram ParseMode.MARKDOWN: –∂–∏—Ä–Ω—ã–π = –æ–¥–∏–Ω *)."""
    lines = text.split("\n")
    out = []
    for line in lines:
        stripped = line.strip()
        if not re.match(r"–î–µ–Ω—å\s+\d+(\s*‚Äî\s*.+)?$", stripped):
            out.append(line)
            continue
        # –ú–æ–¥–µ–ª—å –º–æ–≥–ª–∞ –≤—ã–≤–µ—Å—Ç–∏ **...** ‚Äî —É–±–∏—Ä–∞–µ–º, –≤ Telegram –Ω—É–∂–µ–Ω –æ–¥–∏–Ω *
        if stripped.startswith("**") and stripped.endswith("**"):
            stripped = stripped[2:-2]
        elif stripped.startswith("*") and stripped.endswith("*"):
            out.append(line)
            continue
        prefix = line[: len(line) - len(line.lstrip())]
        out.append(prefix + "*" + stripped + "*")
    return "\n".join(out)


def _telegram_bold_fix(text: str) -> str:
    """–ó–∞–º–µ–Ω—è–µ—Ç **...** –Ω–∞ *...* –ø–æ –≤—Å–µ–º—É —Ç–µ–∫—Å—Ç—É (–≤ Telegram Markdown –∂–∏—Ä–Ω—ã–π ‚Äî –æ–¥–∏–Ω *)."""
    return re.sub(r"\*\*(.+?)\*\*", r"*\1*", text, flags=re.DOTALL)


def _format_qa_answer(text: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ QA –¥–ª—è Telegram: –∂–∏—Ä–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π, –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏."""
    out = _telegram_bold_fix(text)
    out = _bold_day_headers(out)
    # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º ¬´–î–µ–Ω—å N¬ª (–∫—Ä–æ–º–µ —Å–∞–º–æ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –≤ —Ç–µ–∫—Å—Ç–µ) ‚Äî –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
    out = re.sub(r"\n(–î–µ–Ω—å \d+)", r"\n\n\1", out)
    out = re.sub(r"\n{3,}", "\n\n", out)  # –Ω–µ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥—Ä—è–¥
    return out.strip()


def _to_int(s) -> Optional[int]:
    try:
        return int(re.search(r"\d+", str(s)).group(0))
    except Exception:
        return None


class FitnessAgent:
    def __init__(self, token: str, user_id: str):
        self.token = token
        self.user_id = user_id
        self.user_data = load_user_data(user_id)

        phys = self.user_data.get("physical_data") or {}
        self._user_name: Optional[str] = (phys.get("name") or "").strip() or None

        self._phys_prompt = self._format_physical_data(phys)


    async def get_program(self, user_instruction: str = "", focus_group_override: Optional[str] = None) -> str:
        """
        –í–µ—Ä–Ω—ë—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É (Markdown), —Å —É—á—ë—Ç–æ–º –∞–Ω–∫–µ—Ç—ã.
        user_instruction ‚Äî –ø–æ–∂–µ–ª–∞–Ω–∏—è (—Å—Ç–∏–ª—å, –æ–±—ä—ë–º –∏ —Ç.–¥.).
        focus_group_override ‚Äî –ø—Ä–∏ ¬´–î—Ä—É–≥–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞¬ª: –≥—Ä—É–ø–ø–∞, –≤—ã–±—Ä–∞–Ω–Ω–∞—è –≤ —ç—Ç–æ–º –∑–∞–ø—Ä–æ—Å–µ (–¥–ª—è –±–ª–æ–∫–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –æ–±—ä—ë–º–æ–º).
        """
        from asyncio import to_thread
        phys = self.user_data.get("physical_data") or {}
        phys_prompt = self._format_physical_data(phys, focus_group_override=focus_group_override)
        payload = Chat(
            messages=[
                Messages(role=MessagesRole.SYSTEM, content=SYSTEM_PROMPT),
                Messages(role=MessagesRole.USER, content=phys_prompt + (f"\n\n–ü–æ–∂–µ–ª–∞–Ω–∏—è: {user_instruction}" if user_instruction else "")),
            ],
            temperature=GIGACHAT_TEMPERATURE,
            max_tokens=GIGACHAT_MAX_TOKENS,
            model=GIGACHAT_MODEL,
        )

        def _chat_sync():
            last_err = None
            for attempt in range(1, GIGACHAT_RETRIES + 1):
                try:
                    try:
                        with GigaChat(
                            credentials=self.token,
                            verify_ssl_certs=False,
                            timeout=GIGACHAT_TIMEOUT,
                            model=GIGACHAT_MODEL,
                        ) as giga:
                            resp = giga.chat(payload)
                            return resp.choices[0].message.content
                    except TypeError:
                        with GigaChat(
                            credentials=self.token,
                            verify_ssl_certs=False,
                            timeout=GIGACHAT_TIMEOUT,
                        ) as giga:
                            resp = getattr(giga, "chat")(payload, model=GIGACHAT_MODEL)
                            return resp.choices[0].message.content
                except Exception as e:
                    last_err = e
                    if attempt == GIGACHAT_RETRIES:
                        raise
                    time.sleep(1.5 * attempt)
            raise last_err or RuntimeError("GigaChat call failed")

        txt = await to_thread(_chat_sync)
        cleaned = _strip_noise(txt)
        cleaned = _telegram_bold_fix(cleaned)  # **...** ‚Üí *...* –¥–ª—è Telegram
        cleaned = _bold_day_headers(cleaned)
        final = self._with_name_prefix(cleaned)

        # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω—é—é –ø—Ä–æ–≥—Ä–∞–º–º—É
        hist = self.user_data.get("history", [])
        hist.append(("üßç –ó–∞–ø—Ä–æ—Å –ø—Ä–æ–≥—Ä–∞–º–º—ã", "ü§ñ " + final))
        self.user_data["history"] = hist
        self.user_data["last_program"] = final
        self.user_data["last_reply"] = final
        save_user_data(self.user_id, self.user_data)
        return final

    def _qa_history_messages(self, current_question: str, max_turns: int = 6) -> list:
        """–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–∞—Ä—ã –≤–æ–ø—Ä–æ—Å‚Äì–æ—Ç–≤–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ QA, –±–µ–∑ ¬´–ó–∞–ø—Ä–æ—Å –ø—Ä–æ–≥—Ä–∞–º–º—ã¬ª) –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞."""
        hist = self.user_data.get("history", [])
        # –ø–∞—Ä—ã (user, assistant); –∑–∞–ø–∏—Å—å –ø—Ä–æ–≥—Ä–∞–º–º—ã ‚Äî ("üßç –ó–∞–ø—Ä–æ—Å –ø—Ä–æ–≥—Ä–∞–º–º—ã", "ü§ñ ..."), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        turns = []
        for user_msg, bot_msg in hist:
            if user_msg == "üßç –ó–∞–ø—Ä–æ—Å –ø—Ä–æ–≥—Ä–∞–º–º—ã":
                continue
            u = user_msg[2:] if user_msg.startswith("üßç ") else user_msg
            b = bot_msg[2:] if bot_msg.startswith("ü§ñ ") else bot_msg
            turns.append((u, b))
        # –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ max_turns –ø–∞—Ä (–Ω–µ –≤–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å)
        recent = turns[-max_turns:] if len(turns) > max_turns else turns
        messages = [
            Messages(role=MessagesRole.SYSTEM, content=QA_SYSTEM_PROMPT),
            Messages(role=MessagesRole.USER, content=f"–ê–Ω–∫–µ—Ç–∞:\n{self._phys_prompt}"),
        ]
        for u, b in recent:
            messages.append(Messages(role=MessagesRole.USER, content=u))
            messages.append(Messages(role=MessagesRole.ASSISTANT, content=b))
        messages.append(Messages(role=MessagesRole.USER, content=f"–í–æ–ø—Ä–æ—Å (—Ç–µ–∫—É—â–∏–π):\n{current_question}"))
        return messages

    async def get_answer(self, question: str) -> str:
        """
        –ö—Ä–∞—Ç–∫–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç/—Å–æ–≤–µ—Ç. –ï—Å–ª–∏ —è–≤–Ω–æ –ø—Ä–æ—Å—è—Ç –ø–ª–∞–Ω ‚Äî –º–æ–∂–Ω–æ –≤—ã–¥–∞—Ç—å –ø–ª–∞–Ω (—É—á–∏—Ç—ã–≤–∞—è –∞–Ω–∫–µ—Ç—É).
        –£—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∏ –¥–∏–∞–ª–æ–≥–∞ (–∏—Å—Ç–æ—Ä–∏—è QA), —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–ø—Ä–æ—Å –º–µ–Ω—é –Ω–∞ 7 –¥–Ω–µ–π).
        """
        from asyncio import to_thread
        messages = self._qa_history_messages(question)
        payload = Chat(
            messages=messages,
            temperature=min(0.55, max(0.45, GIGACHAT_TEMPERATURE)),  # —á—É—Ç—å –≤—ã—à–µ –¥–ª—è –∂–∏–≤–æ–≥–æ –¥—Ä—É–∂–µ—Å–∫–æ–≥–æ —Ç–æ–Ω–∞
            max_tokens=min(2500, GIGACHAT_MAX_TOKENS),
            model=GIGACHAT_MODEL,
        )

        def _chat_sync():
            try:
                with GigaChat(credentials=self.token, verify_ssl_certs=False, timeout=GIGACHAT_TIMEOUT) as giga:
                    try:
                        resp = giga.chat(payload)
                    except TypeError:
                        resp = getattr(giga, "chat")(payload, model=GIGACHAT_MODEL)
                    return resp.choices[0].message.content
            except Exception as e:
                raise e

        txt = await to_thread(_chat_sync)
        cleaned = _strip_noise(txt).strip()
        cleaned = _format_qa_answer(cleaned)

        # –∏—Å—Ç–æ—Ä–∏—è
        hist = self.user_data.get("history", [])
        hist.append(("üßç " + question, "ü§ñ " + cleaned))
        self.user_data["history"] = hist
        self.user_data["last_reply"] = cleaned
        save_user_data(self.user_id, self.user_data)
        return cleaned


    def _format_physical_data(self, d: dict, focus_group_override: Optional[str] = None) -> str:
        # –±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        result = (
            f"–¶–µ–ª—å: {d.get('target') or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n"
            f"–ü–æ–ª: {d.get('gender') or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\n"
            f"–í–æ–∑—Ä–∞—Å—Ç: {d.get('age') or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'} –ª–µ—Ç\n"
            f"–†–æ—Å—Ç: {d.get('height') or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'} —Å–º\n"
            f"–¢–µ–∫—É—â–∏–π –≤–µ—Å: {d.get('weight') or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'} –∫–≥\n"
            f"–ñ–µ–ª–∞–µ–º—ã–π –≤–µ—Å: {d.get('goal') or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'} –∫–≥\n"
            f"–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: {d.get('restrictions') or '–Ω–µ—Ç'}\n"
            f"–ß–∞—Å—Ç–æ—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: {d.get('schedule') or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\n"
            f"–£—Ä–æ–≤–µ–Ω—å: {d.get('level') or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}"
        )
        # –ö–ë–ñ–£ –ø–æ –ú–∏—Ñ—Ñ–ª–∏–Ω—É-–°–∞–Ω –ñ–µ–æ—Ä–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –≤–µ—Å/—Ä–æ—Å—Ç/–≤–æ–∑—Ä–∞—Å—Ç/–ø–æ–ª
        w, h, a = _to_float(d.get("weight")), _to_float(d.get("height")), _to_float(d.get("age"))
        gender = (d.get("gender") or "").strip().lower()
        is_female = "–∂–µ–Ω" in gender
        sessions = _sessions_per_week(d.get("schedule"))
        kbju = calc_kbju_mifflin_stjeor(w, h, a, is_female, d.get("target"), sessions)
        if kbju:
            kcal, p, f, c = kbju
            result += f"\n–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –ö–ë–ñ–£ (–ú–∏—Ñ—Ñ–ª–∏–Ω-–°–∞–Ω –ñ–µ–æ—Ä–∞): {kcal}/{p}/{f}/{c}"
        
        # –≥—Ä—É–ø–ø–∞ –º—ã—à—Ü: –∏–∑ override (¬´–î—Ä—É–≥–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞¬ª) –∏–ª–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
        preferred_group = focus_group_override if focus_group_override is not None else d.get('preferred_muscle_group')
        if preferred_group and preferred_group not in ('—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ', '–≤—Å–µ –≥—Ä—É–ø–ø—ã –º—ã—à—Ü —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ'):
            # —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –æ–±—ä—ë–º–∞
            exercises_details = {
                '–≥—Ä—É–¥—å': {
                    'examples': '–∂–∏–º —à—Ç–∞–Ω–≥–∏ –ª—ë–∂–∞ (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π, —É–∑–∫–∏–º —Ö–≤–∞—Ç–æ–º), –∂–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞ –∏ –ø–æ–¥ —É–≥–ª–æ–º, –æ—Ç–∂–∏–º–∞–Ω–∏—è (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ, –Ω–∞ –±—Ä—É—Å—å—è—Ö, —Å –≤–æ–∑–≤—ã—à–µ–Ω–∏—è), –∫—Ä–æ—Å—Å–æ–≤–µ—Ä (—Å–Ω–∏–∑—É, —Å–≤–µ—Ä—Ö—É, –ø–æ —Ü–µ–Ω—Ç—Ä—É), —Å–≤–µ–¥–µ–Ω–∏–µ –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞, –∂–∏–º –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ',
                    'types': '–±–∞–∑–æ–≤—ã–µ –∂–∏–º—ã (—à—Ç–∞–Ω–≥–∞, –≥–∞–Ω—Ç–µ–ª–∏, —Ç—Ä–µ–Ω–∞–∂—ë—Ä—ã) –∏ –∏–∑–æ–ª–∏—Ä—É—é—â–∏–µ (—Å–≤–µ–¥–µ–Ω–∏—è, –∫—Ä–æ—Å—Å–æ–≤–µ—Ä)',
                    'volume': '–ø—Ä–∏ –∞–∫—Ü–µ–Ω—Ç–µ –Ω–∞ –≥—Ä—É–¥—å: 4-6 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ –≥—Ä—É–¥—å –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ; –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –æ–±—ä—ë–º 2-3 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è'
                },
                '–Ω–æ–≥–∏': {
                    'examples': '–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ, —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—ã–µ, –±–æ–ª–≥–∞—Ä—Å–∫–∏–µ, –≥–∞–∫–∫, –≤ –°–º–∏—Ç–µ), –≤—ã–ø–∞–¥—ã (–≤–ø–µ—Ä–µ–¥, –Ω–∞–∑–∞–¥, –≤ —Å—Ç–æ—Ä–æ–Ω—É, –ø—Ä–æ—Ö–æ–¥–∫–æ–π), –∂–∏–º –Ω–æ–≥–∞–º–∏ –ø–æ–¥ —Ä–∞–∑–Ω—ã–º–∏ —É–≥–ª–∞–º–∏, —Ä–∞–∑–≥–∏–±–∞–Ω–∏—è/—Å–≥–∏–±–∞–Ω–∏—è –Ω–æ–≥, –∑–∞—à–∞–≥–∏–≤–∞–Ω–∏—è –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, –ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å –ø–∞—É–∑–æ–π; –∏–∫—Ä—ã: –ø–æ–¥—ä—ë–º—ã –Ω–∞ –Ω–æ—Å–∫–∏ —Å—Ç–æ—è, —Å–∏–¥—è, –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ, –ø–æ–æ—á–µ—Ä—ë–¥–Ω—ã–µ –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–≥–µ',
                    'types': '–±–∞–∑–æ–≤—ã–µ –º–Ω–æ–≥–æ—Å—É—Å—Ç–∞–≤–Ω—ã–µ (–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è, –≤—ã–ø–∞–¥—ã, –∂–∏–º—ã –Ω–æ–≥–∞–º–∏), –∏–∑–æ–ª–∏—Ä—É—é—â–∏–µ (—Ä–∞–∑–≥–∏–±–∞–Ω–∏—è, —Å–≥–∏–±–∞–Ω–∏—è) –∏ –∏–∫—Ä—ã –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è –Ω–æ–≥ (1-2 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è)',
                    'volume': '–ø—Ä–∏ –∞–∫—Ü–µ–Ω—Ç–µ –Ω–∞ –Ω–æ–≥–∏: 4-6 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ –Ω–æ–≥–∏ + 1-2 –Ω–∞ –∏–∫—Ä—ã –≤ –∫–∞–∂–¥–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ –Ω–æ–≥; –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –æ–±—ä—ë–º 2-3 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è'
                },
                '—è–≥–æ–¥–∏—Ü—ã': {
                    'examples': '—è–≥–æ–¥–∏—á–Ω—ã–π –º–æ—Å—Ç–∏–∫ (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π, –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–≥–µ, —Å –≤–µ—Å–æ–º), –æ—Ç–≤–µ–¥–µ–Ω–∏—è –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ (—Å—Ç–æ—è, –Ω–∞ —á–µ—Ç–≤–µ—Ä–µ–Ω—å–∫–∞—Ö), —Ä—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞, –≤—ã–ø–∞–¥—ã –Ω–∞–∑–∞–¥ –∏ –≤ —Å—Ç–æ—Ä–æ–Ω—É, –±–æ–ª–≥–∞—Ä—Å–∫–∏–µ —Å–ø–ª–∏—Ç-–ø—Ä–∏—Å–µ–¥—ã, –≥–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏–∏ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —è–≥–æ–¥–∏—Ü—ã, –ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å—É–º–æ, —Å—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞ —Å—É–º–æ',
                    'types': '–±–∞–∑–æ–≤—ã–µ (—Ä—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞, –ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å—É–º–æ) –∏ –∏–∑–æ–ª–∏—Ä—É—é—â–∏–µ (–º–æ—Å—Ç–∏–∫–∏, –æ—Ç–≤–µ–¥–µ–Ω–∏—è)',
                    'volume': '–ø—Ä–∏ –∞–∫—Ü–µ–Ω—Ç–µ –Ω–∞ —è–≥–æ–¥–∏—Ü—ã: 4-6 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ —è–≥–æ–¥–∏—Ü—ã –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ; –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –æ–±—ä—ë–º 2-3 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è'
                },
                '—Å–ø–∏–Ω–∞': {
                    'examples': '—Å—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞ (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è, —Ä—É–º—ã–Ω—Å–∫–∞—è, —Å—É–º–æ), —Ç—è–≥–∏ —à—Ç–∞–Ω–≥–∏/–≥–∞–Ω—Ç–µ–ª–µ–π –≤ –Ω–∞–∫–ª–æ–Ω–µ —Ä–∞–∑–Ω—ã–º–∏ —Ö–≤–∞—Ç–∞–º–∏, –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è (—à–∏—Ä–æ–∫–∏–º, —Å—Ä–µ–¥–Ω–∏–º, —É–∑–∫–∏–º —Ö–≤–∞—Ç–æ–º), —Ç—è–≥–∏ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞ (–∫ –≥—Ä—É–¥–∏, –∑–∞ –≥–æ–ª–æ–≤—É), —Ç—è–≥–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞ (–∫ –ø–æ—è—Å—É, –∫ –≥—Ä—É–¥–∏), —Ç—è–≥–∞ –¢-–≥—Ä–∏—Ñ–∞, —à—Ä–∞–≥–∏ (—Å–æ —à—Ç–∞–Ω–≥–æ–π, –≥–∞–Ω—Ç–µ–ª—è–º–∏), –ø—É–ª–æ–≤–µ—Ä—ã',
                    'types': '–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —Ç—è–≥–∏ (–ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è, —Ç—è–≥–∏ –±–ª–æ–∫–∞) –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ç—è–≥–∏ (—Ç—è–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ, –±–ª–æ–∫–∞ –∫ –ø–æ—è—Å—É)',
                    'volume': '–ø—Ä–∏ –∞–∫—Ü–µ–Ω—Ç–µ –Ω–∞ —Å–ø–∏–Ω—É: 4-6 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ —Å–ø–∏–Ω—É –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ; –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –æ–±—ä—ë–º 2-3 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è'
                },
                '–ø–ª–µ—á–∏': {
                    'examples': '–∂–∏–º—ã —à—Ç–∞–Ω–≥–∏/–≥–∞–Ω—Ç–µ–ª–µ–π (—Å—Ç–æ—è, —Å–∏–¥—è), –º–∞—Ö–∏ –≥–∞–Ω—Ç–µ–ª–µ–π –≤ —Å—Ç–æ—Ä–æ–Ω—ã, –º–∞—Ö–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ, –ø–æ–¥—ä—ë–º—ã –ø–µ—Ä–µ–¥ —Å–æ–±–æ–π, —Ä–∞–∑–≤–µ–¥–µ–Ω–∏—è –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ, –∂–∏–º –ê—Ä–Ω–æ–ª—å–¥–∞',
                    'types': '–±–∞–∑–æ–≤—ã–µ –∂–∏–º—ã –∏ –∏–∑–æ–ª–∏—Ä—É—é—â–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ–¥–Ω–µ–≥–æ, —Å—Ä–µ–¥–Ω–µ–≥–æ –∏ –∑–∞–¥–Ω–µ–≥–æ –ø—É—á–∫–æ–≤',
                    'volume': '–ø—Ä–∏ –∞–∫—Ü–µ–Ω—Ç–µ –Ω–∞ –ø–ª–µ—á–∏: 3-5 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ –ø–ª–µ—á–∏ –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ; –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –æ–±—ä—ë–º 2-3 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è'
                },
                '—Ä—É–∫–∏': {
                    'examples': '–ë–ò–¶–ï–ü–°: –ø–æ–¥—ä—ë–º—ã —à—Ç–∞–Ω–≥–∏/–≥–∞–Ω—Ç–µ–ª–µ–π, –º–æ–ª–æ—Ç–∫–æ–≤—ã–µ —Å–≥–∏–±–∞–Ω–∏—è, —Å–∫–∞–º—å—è –°–∫–æ—Ç—Ç–∞. –¢–†–ò–¶–ï–ü–°: —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º, —Ä–∞–∑–≥–∏–±–∞–Ω–∏—è –Ω–∞ –±–ª–æ–∫–µ, –æ—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö, –∂–∏–º —É–∑–∫–∏–º —Ö–≤–∞—Ç–æ–º',
                    'types': '–±–∞–∑–æ–≤—ã–µ (–±—Ä—É—Å—å—è, –∂–∏–º—ã) –∏ –∏–∑–æ–ª–∏—Ä—É—é—â–∏–µ (—Å–≥–∏–±–∞–Ω–∏—è, —Ä–∞–∑–≥–∏–±–∞–Ω–∏—è)',
                    'volume': '–ø—Ä–∏ –∞–∫—Ü–µ–Ω—Ç–µ –Ω–∞ —Ä—É–∫–∏: 4-6 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ —Ä—É–∫–∏ –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ (2-3 –±–∏—Ü–µ–ø—Å, 2-3 —Ç—Ä–∏—Ü–µ–ø—Å); –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –æ–±—ä—ë–º 2-3 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è'
                },
                '–ø–ª–µ—á–∏ –∏ —Ä—É–∫–∏': {
                    'examples': '–ü–õ–ï–ß–ò: –∂–∏–º—ã —à—Ç–∞–Ω–≥–∏/–≥–∞–Ω—Ç–µ–ª–µ–π (—Å—Ç–æ—è, —Å–∏–¥—è), –º–∞—Ö–∏ –≥–∞–Ω—Ç–µ–ª–µ–π (–≤ —Å—Ç–æ—Ä–æ–Ω—ã, –≤–ø–µ—Ä—ë–¥, –≤ –Ω–∞–∫–ª–æ–Ω–µ), —Ç—è–≥–∏ –∫ –ø–æ–¥–±–æ—Ä–æ–¥–∫—É, –∂–∏–º –ê—Ä–Ω–æ–ª—å–¥–∞. –ë–ò–¶–ï–ü–°: –ø–æ–¥—ä—ë–º—ã —à—Ç–∞–Ω–≥–∏/–≥–∞–Ω—Ç–µ–ª–µ–π, –º–æ–ª–æ—Ç–∫–æ–≤—ã–µ, —Å–≥–∏–±–∞–Ω–∏—è –Ω–∞ —Å–∫–∞–º—å–µ –°–∫–æ—Ç—Ç–∞. –¢–†–ò–¶–ï–ü–°: —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º, –æ—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö, —Ä–∞–∑–≥–∏–±–∞–Ω–∏—è –Ω–∞ –±–ª–æ–∫–µ',
                    'types': '–±–∞–∑–æ–≤—ã–µ (–∂–∏–º—ã –ø–ª–µ—á, –±—Ä—É—Å—å—è) –∏ –∏–∑–æ–ª–∏—Ä—É—é—â–∏–µ (–º–∞—Ö–∏, —Å–≥–∏–±–∞–Ω–∏—è, —Ä–∞–∑–≥–∏–±–∞–Ω–∏—è)',
                    'volume': '–ø—Ä–∏ –∞–∫—Ü–µ–Ω—Ç–µ –Ω–∞ –ø–ª–µ—á–∏ –∏ —Ä—É–∫–∏: 3-5 –Ω–∞ –ø–ª–µ—á–∏ + 2-3 –±–∏—Ü–µ–ø—Å + 2-3 —Ç—Ä–∏—Ü–µ–ø—Å –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ; –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –æ–±—ä—ë–º 2-3 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è'
                },
                '–∫–æ—Ä –∏ –ø—Ä–µ—Å—Å': {
                    'examples': '–ø–ª–∞–Ω–∫–∏ (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ, –±–æ–∫–æ–≤—ã–µ), –ø–æ–¥—ä—ë–º—ã –Ω–æ–≥ –≤ –≤–∏—Å–µ/–ª—ë–∂–∞, —Å–∫—Ä—É—á–∏–≤–∞–Ω–∏—è, ¬´–º—ë—Ä—Ç–≤—ã–π –∂—É–∫¬ª, —Ä–æ–ª–ª–∞—É—Ç—ã —Å –∫–æ–ª–µ—Å–æ–º, Pallof press, –≥–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏–∏',
                    'types': '—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ (–ø–ª–∞–Ω–∫–∏) –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ (—Å–∫—Ä—É—á–∏–≤–∞–Ω–∏—è, –ø–æ–¥—ä—ë–º—ã –Ω–æ–≥)',
                    'volume': '2-4 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ –∫–æ—Ä –≤ –∫–∞–∂–¥–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ)'
                },
                '—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É—é—â–∏–µ': {
                    'examples': '–≤—ã–ø–∞–¥—ã —Å –ø–æ–≤–æ—Ä–æ—Ç–æ–º –∫–æ—Ä–ø—É—Å–∞, –ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–≥–µ, —Ç—è–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ –æ–¥–Ω–æ–π —Ä—É–∫–æ–π, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å —Ä–µ–∑–∏–Ω–∫–∞–º–∏, –±–∞–ª–∞–Ω—Å –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–≥–µ',
                    'types': '–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∏ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è',
                    'volume': '1-3 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ'
                },
            }
            volume_meta = (
                "–û–ë–™–Å–ú –ó–ê –¢–†–ï–ù–ò–†–û–í–ö–£: –ø—Ä–∏ –∞–∫—Ü–µ–Ω—Ç–µ –Ω–∞ –≥—Ä—É–ø–ø—É ‚Äî 4‚Äì6 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ –Ω–µ—ë; "
                "–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî 2‚Äì3 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è; "
                "–æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∑–∞ –æ–¥–Ω—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É: 6‚Äì9. "
                "–í–∫–ª—é—á–∞–π 2‚Äì4 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ –∫–æ—Ä/–ø—Ä–µ—Å—Å –≤ –Ω–µ–¥–µ–ª—é; –ø—Ä–∏ –¥–Ω–µ –Ω–æ–≥ ‚Äî –∏–∫—Ä—ã –≤ –∫–æ–Ω—Ü–µ (1‚Äì2 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è)."
            )
            details = exercises_details.get(preferred_group, {})
            result += (
                f"\n\nüéØ ‚ïê‚ïê‚ïê –ì–õ–ê–í–ù–´–ô –ü–†–ò–û–†–ò–¢–ï–¢ –ü–†–û–ì–†–ê–ú–ú–´ ‚ïê‚ïê‚ïê\n"
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –ê–ö–¶–ï–ù–¢ –ù–ê {preferred_group.upper()}!\n\n"
                f"üìã –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ü–†–û–ì–†–ê–ú–ú–ï:\n\n"
                f"1Ô∏è‚É£ –û–ë–™–Å–ú –ù–ê–ì–†–£–ó–ö–ò:\n"
                f"   ‚Ä¢ {details.get('volume', f'–ü—Ä–∏ –∞–∫—Ü–µ–Ω—Ç–µ: 4‚Äì6 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ {preferred_group}; –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã ‚Äî 2‚Äì3 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è')}\n"
                f"   ‚Ä¢ {volume_meta} (—ç—Ç–æ –û–ë–©–ï–ï –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–±—ä—ë–º–∞, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ)\n\n"
                f"2Ô∏è‚É£ –°–¢–†–£–ö–¢–£–†–ê –¢–†–ï–ù–ò–†–û–í–û–ö:\n"
                f"   ‚Ä¢ –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–∫—É—Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî {preferred_group}\n"
                f"   ‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –±–∞–∑–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ {preferred_group}, –Ω–æ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –∏–ª–∏ –∏–∑–æ–ª—è—Ü–∏—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\n"
                f"   ‚Ä¢ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ—á–µ—Ç–∞–π –±–∞–∑–æ–≤—ã–µ –∏ –∏–∑–æ–ª–∏—Ä—É—é—â–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è\n"
                f"   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ —É–≥–ª—ã, —Ö–≤–∞—Ç—ã, —Å—Ç–æ–π–∫–∏ –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è\n\n"
                f"3Ô∏è‚É£ –ü–†–ò–ú–ï–†–´ –£–ü–†–ê–ñ–ù–ï–ù–ò–ô (–¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞, –ù–ï –∫–∞–∫ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫):\n"
                f"   {details.get('examples', f'—Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ {preferred_group}')}\n\n"
                f"üîÑ –í–ê–†–ò–ê–¢–ò–í–ù–û–°–¢–¨:\n"
                f"   ‚Ä¢ –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –Ω–∞–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏–∑ –Ω–µ–¥–µ–ª–∏ –≤ –Ω–µ–¥–µ–ª—é\n"
                f"   ‚Ä¢ –î–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –∑–∞–º–µ–Ω–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω—ã–µ –ø–æ –±–∏–æ–º–µ—Ö–∞–Ω–∏–∫–µ\n\n"
                f"‚ö†Ô∏è –í–ê–ñ–ù–û:\n"
                f"   ‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞\n"
                f"   ‚Ä¢ –î–æ–ø—É—Å–∫–∞—é—Ç—Å—è –õ–Æ–ë–´–ï –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ {preferred_group}, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —É—Ä–æ–≤–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
                f"   ‚Ä¢ –ú–∏–Ω–∏–º—É–º –¥–≤–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ –Ω–µ–¥–µ–ª—é –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —è–≤–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ {preferred_group}"
            )
        
        return result

    def _with_name_prefix(self, text: str) -> str:
        name = (self._user_name or "").strip()
        return (f"{name}, –ª–æ–≤–∏ –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ üí™üèº –ï—Å–ª–∏ —Ç–µ–±–µ –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è —ç—Ç–æ—Ç –ø–ª–∞–Ω, –Ω–µ –∑–∞–±—É–¥—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ ‚¨áÔ∏è\n\n" if name else "") + text